<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Timer Pro</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --font-main: 'Outfit', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --bg-color: #050505;
            --text-color: #FFFFFF;
            --accent-glow: 253, 68, 86;
            --text-stroke: transparent;
            --control-bg: rgba(255, 255, 255, 0.1);
            --control-border: rgba(255, 255, 255, 0.12);
            --focus-ring: rgba(255, 255, 255, 0.5);
            --progress-width: 50px;
            --transition-theme: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);

            /* Editor Specifics */
            --card-bg: #1A1A1A;
            --card-border: #333333;
            --input-bg: #111111;
        }

        body.theme-red {
            --bg-color: #FD4456;
            --text-color: #0D1A22;
            --accent-glow: 0, 0, 0;
            --text-stroke: rgba(0, 0, 0, 0.2);
            --control-bg: rgba(13, 26, 34, 0.1);
            --control-border: rgba(13, 26, 34, 0.2);
        }

        body.theme-blue {
            --bg-color: #0052A3;
            --text-color: #FFFFFF;
            --accent-glow: 74, 144, 226;
        }

        body.theme-green {
            --bg-color: #00AA00;
            --text-color: #FFFFFF;
            --accent-glow: 255, 255, 255;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            transition: background-color 0.3s ease, color 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
        }

        #progress-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #border-path {
            fill: none;
            stroke: var(--text-color);
            stroke-width: var(--progress-width);
            stroke-opacity: 0.9;
            stroke-linecap: butt;
            stroke-linejoin: miter;
            filter: drop-shadow(0 0 4px rgba(var(--accent-glow), 0.5));
            transition: stroke 0.3s ease, filter 0.3s ease;
        }

        /* FOCUS MODE FIX */
        body.running-focus .controls-bar,
        body.running-focus .mode-switcher,
        body.running-focus .shortcuts-legend,
        body.running-focus #editor-modal {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-out;
        }

        body.running-focus .timer-display,
        body.running-focus #progress-svg,
        body.running-focus .circuit-status {
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 20 !important;
        }

        .app-shell {
            position: relative;
            z-index: 20;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .timer-display {
            font-size: 50vmin;
            font-weight: 600;
            line-height: 0.85;
            letter-spacing: -0.02em;
            font-variant-numeric: tabular-nums;
            display: inline-flex;
            align-items: baseline;
            gap: 0;
            cursor: default;
            -webkit-text-stroke: 1px var(--text-stroke);
            text-shadow: 0 0 30px rgba(var(--accent-glow), 0.4);
            transition: transform 1s linear;
            will-change: transform;
            z-index: 20;
        }

        .timer-display.long-text {
            font-size: 15vw;
            /* Universal scaling for "Time's Up" */
        }

        .circuit-status {
            position: absolute;
            top: 15vh;
            font-size: 1.5rem;
            font-weight: 600;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: opacity 0.3s;
        }

        .timer-segment {
            position: relative;
            min-width: 0.5em;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            padding: 0 0.1em;
            transition: background 0.2s ease;
        }

        .timer-segment:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .timer-segment.editing {
            background: rgba(255, 255, 255, 0.1);
            outline: 3px solid rgba(255, 255, 255, 0.5);
            outline-offset: 4px;
            animation: editPulse 1.5s ease-in-out infinite;
            cursor: text;
        }

        .timer-separator {
            padding: 0 0.05em;
            opacity: 0.8;
            pointer-events: none;
        }

        @keyframes editPulse {

            0%,
            100% {
                outline-color: rgba(255, 255, 255, 0.3);
            }

            50% {
                outline-color: rgba(255, 255, 255, 0.6);
            }
        }

        @media (min-width: 1200px) {
            .timer-display {
                font-size: 60vmin;
            }
        }

        .controls-bar {
            position: absolute;
            bottom: calc(var(--progress-width) + 2rem);
            display: flex;
            gap: 1rem;
            transition: opacity 0.5s ease;
            z-index: 100;
            /* Boosted for Mobile Click Fix */
        }

        .btn {
            background: var(--control-bg);
            border: 1px solid var(--control-border);
            color: var(--text-color);
            padding: 12px 24px;
            border-radius: 8px;
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.1rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: transform 0.1s active, background 0.2s;
            min-width: 80px;
        }

        .btn:active {
            transform: scale(0.96);
        }

        .mode-switcher {
            position: absolute;
            top: calc(var(--progress-width) + 2rem);
            right: calc(var(--progress-width) + 2rem);
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(4px);
            padding: 6px;
            border-radius: 16px;
            display: flex;
            gap: 4px;
            z-index: 30;
            transition: opacity 0.5s ease;
        }

        .mode-btn {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: #FFF;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.theme-red .mode-btn {
            color: rgba(13, 26, 34, 0.5);
        }

        body.theme-red .mode-btn.active {
            background: rgba(13, 26, 34, 0.15);
            color: #0D1A22;
        }

        .error-toast,
        .mobile-toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            background: #FD4456;
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            pointer-events: none;
        }

        .error-toast {
            bottom: 15vh;
            animation: slideUp 0.3s ease;
        }

        .mobile-toast {
            top: 20px;
            background: rgba(0, 150, 255, 0.95);
            animation: toastSlideIn 0.3s ease;
        }

        .toast-success {
            background: rgba(0, 200, 100, 0.95);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @media (orientation: portrait) {
            .timer-display {
                font-size: 25vw;
            }
        }

        .hidden {
            display: none !important;
        }

        /* SHORTCUTS LEGEND */
        .shortcuts-legend {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            /* MOVED TO LEFT */
            z-index: 100;
            display: none;
        }

        @media (min-width: 768px) {
            .shortcuts-legend {
                display: block;
            }
        }

        /* SOCIAL STACK (Right) */
        .social-stack {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }

        /* Focus Mode Hiding */
        body.running-focus .social-stack,
        body.running-focus .shortcuts-legend {
            opacity: 0;
            pointer-events: none;
        }

        .coffee-link,
        .star-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .coffee-link:hover,
        .star-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .star-btn {
            position: relative;
            overflow: visible;
        }

        .star-count {
            position: absolute;
            right: 110%;
            /* Left of button */
            font-size: 0.9rem;
            font-weight: 700;
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 8px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
        }

        .social-stack:hover .star-count {
            opacity: 1;
        }

        .shortcuts-toggle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .shortcuts-panel {
            position: absolute;
            bottom: 60px;
            left: 0;
            /* Align to the LEFT now */
            right: auto;
            width: 280px;
            background: rgba(20, 20, 20, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .shortcuts-panel.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .shortcut-item kbd {
            min-width: 48px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-family: monospace;
            font-weight: 600;
            text-align: center;
            color: white;
            margin-right: 1rem;
        }

        .shortcut-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            z-index: 10000;
            pointer-events: none;
            animation: feedbackAnim 0.8s ease;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        @keyframes feedbackAnim {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }

            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
        }

        /* PICKER */
        .timer-input-mobile,
        .edit-input-popup {
            display: none;
            position: fixed;
            z-index: 2000;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .timer-input-mobile.open,
        .edit-input-popup.open {
            display: flex;
        }

        .picker-container {
            width: 90%;
            max-width: 320px;
            background: #1A1A1A;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .picker-row {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 180px;
            position: relative;
        }

        .picker-wheel {
            display: inline-block;
            width: 80px;
            height: 180px;
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
        }

        .picker-item {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.4);
        }

        .picker-item.selected {
            font-size: 2.2rem;
            font-weight: 600;
            color: #FFFFFF;
        }

        .picker-highlight {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            height: 60px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: none;
            z-index: 1;
        }

        /* EDITOR MODAL */
        #editor-modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: #080808;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #editor-modal.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-header {
            text-align: center;
            padding: 2rem 1rem 1rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.4);
            margin-bottom: 1rem;
        }

        .rounds-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .rounds-btn {
            width: 48px;
            height: 48px;
            background: #262626;
            border: 1px solid #404040;
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .rounds-btn:active {
            background: #333;
        }

        .rounds-display {
            width: 48px;
            height: 48px;
            border: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 700;
            background: #000;
            border-radius: 4px;
        }

        .total-duration {
            background: white;
            color: black;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
            font-size: 1rem;
        }

        .editor-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .editor-footer {
            padding: 2rem;
            display: flex;
            justify-content: center;
            gap: 2rem;
            align-items: center;
            background: #080808;
            border-top: 1px solid #222;
        }

        .footer-btn {
            background: transparent;
            border: 1px solid #404040;
            color: white;
            padding: 12px 32px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 140px;
        }

        .footer-btn:hover {
            background: #1a1a1a;
        }

        .footer-btn.primary {
            background: white;
            color: black;
            border: none;
            font-weight: 700;
        }

        .footer-btn.primary:hover {
            transform: scale(1.05);
        }

        .footer-btn.text {
            border: none;
        }

        /* DRAG & DROP VISUALS */
        .interval-card {
            background: #111;
            border: 2px solid #333;
            height: 80px;
            display: grid;
            grid-template-columns: 48px 1fr auto auto;
            align-items: center;
            gap: 1rem;
            padding: 0 1rem;
            transition: transform 0.25s, opacity 0.25s;
            position: relative;
            will-change: transform;
            user-select: none;
        }

        /* Draggable List State */
        .editor-content.is-dragging-active .interval-card {
            opacity: 0.7;
        }

        .editor-content.is-dragging-active .interval-card.drag-placeholder {
            opacity: 0.3;
            border: 1px dashed #444;
        }

        /* Floating Ghost Card */
        .drag-ghost {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.9;
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            width: var(--ghost-width, auto);
            height: var(--ghost-height, auto);
            border: 2px solid #FD4456;
            background: #111;
            /* Layout must match grid */
            display: grid;
            grid-template-columns: 48px 1fr auto auto;
            align-items: center;
            gap: 1rem;
            padding: 0 1rem;
        }

        /* Drop Line Indicator */
        .drop-indicator {
            height: 4px;
            background: #FD4456;
            border-radius: 2px;
            box-shadow: 0 0 10px #FD4456, 0 0 20px #FD4456;
            margin: 8px 0;
            position: relative;
            animation: pulseLine 1s infinite alternate;
            pointer-events: none;
        }

        .drop-indicator::before,
        .drop-indicator::after {
            content: "▼";
            position: absolute;
            color: #FD4456;
            font-size: 12px;
            top: -14px;
        }

        .drop-indicator::before {
            left: 0;
        }

        .drop-indicator::after {
            right: 0;
        }

        @keyframes pulseLine {
            from {
                opacity: 0.6;
                box-shadow: 0 0 5px #FD4456;
            }

            to {
                opacity: 1;
                box-shadow: 0 0 15px #FD4456;
            }
        }

        .drag-handle {
            color: rgba(255, 255, 255, 0.4);
            font-size: 1.5rem;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            touch-action: none;
        }

        .card-name-input {
            background: transparent;
            border: none;
            color: white;
            font-family: var(--font-main);
            font-size: 1rem;
            font-weight: 700;
            width: 100%;
            padding: 8px 0;
        }

        .card-name-input:focus {
            outline: none;
            border-bottom: 1px solid #555;
        }

        .time-control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mini-btn {
            width: 40px;
            height: 40px;
            background: #262626;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .mini-btn:hover {
            background: #333;
            color: white;
        }

        .time-display-box {
            width: 100px;
            height: 40px;
            border: 1px solid #404040;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn-delete {
            color: #FF453A;
            background: transparent;
            border: none;
            font-size: 1.2rem;
            padding: 8px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .btn-delete:hover {
            opacity: 1;
        }

        @media (max-width: 600px) {
            .interval-card {
                height: auto;
                grid-template-columns: 48px 1fr auto;
                grid-template-rows: auto auto;
                padding: 1rem;
            }

            .drag-handle {
                grid-row: 1 / 3;
            }

            /* MOBILE COMPACT VIEW (Portrait Only) */
            @media (orientation: portrait) {
                .editor-content {
                    gap: 0.6rem !important;
                    padding: 0.5rem !important;
                }

                .interval-card {
                    padding: 0.6rem !important;
                    /* Reduced padding */
                    gap: 0.5rem !important;
                    /* Tighter elements */
                    /* Grid needs update: Name and Timer side-by-side */
                    grid-template-columns: 32px 1fr auto 32px !important;
                    grid-template-rows: auto !important;
                    height: auto !important;
                    min-height: 54px;
                    /* Sufficient for 44px touch target */
                }

                .drag-handle {
                    grid-row: 1 !important;
                    font-size: 1.2rem;
                    width: 32px;
                }

                .card-name-input {
                    grid-column: 2 / 3 !important;
                    /* Name next to handle */
                    margin-bottom: 0 !important;
                    font-size: 0.85rem !important;
                }

                .time-control-group {
                    grid-column: 3 / 4 !important;
                    /* Timer inline */
                    transform: scale(0.9);
                    /* Slight scale down */
                    transform-origin: right center;
                }

                .mini-btn {
                    width: 36px;
                    height: 36px;
                    /* Still clearly tap-able */
                    font-size: 1.2rem;
                }

                .time-display-box {
                    width: 70px;
                    height: 36px;
                    font-size: 0.8rem;
                }

                .btn-delete {
                    grid-column: 4 / 5 !important;
                    font-size: 1rem;
                    padding: 6px;
                }
            }

            .card-name-input {
                grid-column: 2 / 4;
                margin-bottom: 0.5rem;
            }

            .time-control-group {
                grid-column: 2 / 3;
            }

            .btn-delete {
                grid-column: 3 / 4;
            }

            .editor-footer {
                flex-direction: column;
                gap: 1rem;
            }

            .footer-btn {
                width: 100%;
            }
        }
    </style>
</head>

<body class="theme-black">
    <div id="flash-overlay"></div>
    <svg id="progress-svg">
        <path id="border-path" d="" />
    </svg>

    <div class="app-shell">
        <header class="mode-switcher">
            <button class="mode-btn active" onclick="setMode('quick')">Quick</button>
            <button class="mode-btn" onclick="setMode('circuit')">Circuit</button>
        </header>

        <main id="main-timer" aria-live="polite">
            <div id="circuit-status" class="circuit-status hidden">Ready</div>
            <div id="timer-text" class="timer-display" role="timer">
                <span class="timer-segment minutes" aria-label="Minutes">10</span><span
                    class="timer-separator">:</span><span class="timer-segment seconds" aria-label="Seconds">00</span>
            </div>
        </main>

        <footer class="controls-bar" id="normalControls">
            <button class="btn" id="btn-reset">Reset</button>
            <button class="btn" id="btn-start" style="background: rgba(var(--accent-glow), 0.3);">Start</button>
        </footer>
    </div>

    <div id="editor-modal">
        <div class="modal-header">
            <div class="modal-title">Design your workout rounds</div>
            <div style="font-size:0.9rem; color:rgba(255,255,255,0.6); margin-bottom:8px">Circuit rounds:</div>
            <div class="rounds-control">
                <button class="rounds-btn" onclick="CircuitController.updateRounds(-1)">&minus;</button>
                <div class="rounds-display" id="rounds-count">3</div>
                <button class="rounds-btn" onclick="CircuitController.updateRounds(1)">&plus;</button>
            </div>
            <div class="total-duration" id="total-duration">Total Duration: 0m 00s</div>
        </div>

        <div class="editor-content" id="interval-list">
            <!-- Cards go here -->
        </div>

        <div class="editor-footer">
            <button class="footer-btn" onclick="setMode('quick')">Back</button>
            <button class="footer-btn text" onclick="CircuitController.addInterval()">+ Add Round</button>
            <button class="footer-btn primary" onclick="CircuitController.startQueue()">Start Circuit</button>
        </div>
    </div>

    <!-- PICKER -->
    <div class="timer-input-mobile" id="mobileTimerInput">
        <div class="picker-container">
            <div class="picker-row">
                <div id="minutesPicker"></div>
                <div style="padding:0 10px; font-size:2rem; opacity:0.6">:</div>
                <div id="secondsPicker"></div>
            </div>
            <button class="btn" id="setTimeBtn"
                style="width:100%; background:rgba(255,255,255,0.2); margin-top:20px;">Set Time</button>
        </div>
    </div>

    <!-- SHORTCUTS -->
    <div class="shortcuts-legend" id="shortcutsLegend">
        <button class="shortcuts-toggle" id="shortcutsToggle">⌨️</button>
        <div class="shortcuts-panel" id="shortcutsPanel">
            <div class="shortcuts-header">
                <h3>Keyboard Shortcuts</h3>
            </div>
            <div class="shortcuts-list">
                <div class="shortcut-item"><kbd>Space</kbd><span>Start/Pause</span></div>
                <div class="shortcut-item"><kbd>R</kbd><span>Reset</span></div>
            </div>
        </div>
    </div>

    <!-- COFFEE LINK -->
    <!-- SOCIAL STACK -->
    <div class="social-stack">
        <a href="https://github.com/Manav-repo/Timer-pro" target="_blank" class="star-btn" aria-label="Star on GitHub">
            <span class="star-count" id="starCount">Top Secret</span>
            <svg height="24" viewBox="0 0 16 16" width="24" fill="currentColor">
                <path
                    d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.75.75 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z">
                </path>
            </svg>
        </a>
        <a href="https://buymeacoffee.com/manavbuilds" target="_blank" class="coffee-link" aria-label="Buy me a coffee">
            <svg width="24" height="24" viewBox="0 0 27 39" fill="none" xmlns="http://www.w3.org/2000/svg"
                style="transform: scale(0.85);">
                <path
                    d="M14.3206 17.9122C12.9282 18.5083 11.3481 19.1842 9.30013 19.1842C8.44341 19.1824 7.59085 19.0649 6.76562 18.8347L8.18203 33.3768C8.23216 33.9847 8.50906 34.5514 8.95772 34.9645C9.40638 35.3776 9.994 35.6069 10.6039 35.6068C10.6039 35.6068 12.6122 35.7111 13.2823 35.7111C14.0036 35.7111 16.1662 35.6068 16.1662 35.6068C16.776 35.6068 17.3635 35.3774 17.8121 34.9643C18.2606 34.5512 18.5374 33.9846 18.5876 33.3768L20.1046 17.3073C19.4267 17.0757 18.7425 16.9219 17.9712 16.9219C16.6372 16.9214 15.5623 17.3808 14.3206 17.9122Z"
                    fill="#FFDD00" />
                <path
                    d="M26.6584 10.3609L26.4451 9.28509C26.2537 8.31979 25.8193 7.40768 24.8285 7.05879C24.5109 6.94719 24.1505 6.89922 23.907 6.66819C23.6634 6.43716 23.5915 6.07837 23.5351 5.74565C23.4308 5.13497 23.3328 4.52377 23.2259 3.91413C23.1336 3.39002 23.0606 2.80125 22.8202 2.32042C22.5073 1.6748 21.858 1.29723 21.2124 1.04743C20.8815 0.923938 20.5439 0.819467 20.2012 0.734533C18.5882 0.308987 16.8922 0.152536 15.2328 0.0633591C13.241 -0.046547 11.244 -0.0134338 9.25692 0.162444C7.77794 0.296992 6.22021 0.459701 4.81476 0.971295C4.30108 1.15851 3.77175 1.38328 3.38115 1.78015C2.90189 2.26775 2.74544 3.02184 3.09537 3.62991C3.34412 4.06172 3.7655 4.3668 4.21242 4.56862C4.79457 4.82867 5.40253 5.02654 6.02621 5.15896C7.76282 5.54279 9.56148 5.6935 11.3356 5.75765C13.302 5.83701 15.2716 5.77269 17.2286 5.56521C17.7126 5.51202 18.1956 5.44822 18.6779 5.37382C19.2458 5.28673 19.6103 4.54411 19.4429 4.02678C19.2427 3.40828 18.7045 3.16839 18.0959 3.26173C18.0062 3.27581 17.917 3.28885 17.8273 3.30189L17.7626 3.31128C17.5565 3.33735 17.3503 3.36169 17.1441 3.38429C16.7182 3.43018 16.2913 3.46773 15.8633 3.49693C14.9048 3.56368 13.9437 3.59445 12.9831 3.59602C12.0391 3.59602 11.0947 3.56942 10.1529 3.50736C9.72314 3.4792 9.29447 3.44339 8.86684 3.39993C8.67232 3.37959 8.47832 3.35821 8.28432 3.33422L8.0997 3.31076L8.05955 3.30502L7.86816 3.27738C7.47703 3.21845 7.0859 3.15066 6.69895 3.06878C6.6599 3.06012 6.62498 3.03839 6.59994 3.0072C6.57491 2.976 6.56127 2.9372 6.56127 2.8972C6.56127 2.85721 6.57491 2.81841 6.59994 2.78721C6.62498 2.75602 6.6599 2.73429 6.69895 2.72563H6.70625C7.04158 2.65418 7.37951 2.59317 7.71849 2.53997C7.83148 2.52224 7.94482 2.50486 8.05851 2.48782H8.06164C8.27389 2.47374 8.48718 2.43567 8.69839 2.41064C10.536 2.2195 12.3845 2.15434 14.231 2.2156C15.1275 2.24168 16.0234 2.29435 16.9157 2.38509C17.1076 2.40491 17.2985 2.42577 17.4894 2.44923C17.5624 2.4581 17.6359 2.46853 17.7094 2.47739L17.8575 2.49878C18.2893 2.56309 18.7189 2.64115 19.1462 2.73293C19.7793 2.87061 20.5923 2.91546 20.8739 3.60906C20.9636 3.82913 21.0043 4.07371 21.0538 4.30474L21.1169 4.59939C21.1186 4.60467 21.1198 4.61008 21.1206 4.61555C21.2697 5.31089 21.4191 6.00623 21.5686 6.70157C21.5795 6.75293 21.5798 6.80601 21.5693 6.85748C21.5589 6.90895 21.5379 6.95771 21.5078 7.00072C21.4776 7.04373 21.4389 7.08007 21.3941 7.10747C21.3493 7.13487 21.2993 7.15274 21.2473 7.15997H21.2431L21.1519 7.17248L21.0617 7.18448C20.7759 7.22168 20.4897 7.25644 20.2033 7.28878C19.639 7.3531 19.0739 7.40872 18.5079 7.45566C17.3831 7.54918 16.2562 7.61055 15.127 7.63975C14.5516 7.65505 13.9763 7.66217 13.4013 7.66113C11.1124 7.65933 8.82553 7.5263 6.55188 7.2627C6.30574 7.2335 6.05959 7.20221 5.81344 7.1704C6.00431 7.19491 5.67472 7.15162 5.60797 7.14224C5.45152 7.12033 5.29506 7.09756 5.13861 7.07392C4.61346 6.99517 4.09144 6.89817 3.56733 6.81317C2.9337 6.70887 2.32771 6.76102 1.75458 7.07392C1.28413 7.33136 0.903361 7.72614 0.663078 8.20558C0.415886 8.71665 0.342354 9.2731 0.231796 9.82224C0.121237 10.3714 -0.0508594 10.9622 0.0143284 11.526C0.154613 12.7427 1.00518 13.7314 2.22863 13.9525C3.37959 14.1611 4.5368 14.3301 5.69714 14.474C10.2552 15.0323 14.8601 15.0991 19.4325 14.6733C19.8048 14.6385 20.1767 14.6006 20.548 14.5596C20.6639 14.5468 20.7813 14.5602 20.8914 14.5987C21.0016 14.6372 21.1017 14.6998 21.1845 14.782C21.2673 14.8642 21.3307 14.9639 21.37 15.0737C21.4093 15.1836 21.4235 15.3009 21.4116 15.4169L21.2958 16.5423C21.0625 18.8164 20.8292 21.0903 20.596 23.3641C20.3526 25.7519 20.1077 28.1395 19.8612 30.5269C19.7916 31.1993 19.7221 31.8715 19.6526 32.5436C19.5858 33.2054 19.5764 33.888 19.4507 34.542C19.2526 35.5704 18.5564 36.2019 17.5405 36.433C16.6098 36.6448 15.659 36.756 14.7045 36.7646C13.6464 36.7704 12.5888 36.7234 11.5307 36.7292C10.4011 36.7354 9.01755 36.6311 8.1456 35.7905C7.37951 35.052 7.27365 33.8958 7.16935 32.8961C7.03028 31.5725 6.89243 30.2491 6.75579 28.9259L5.98918 21.568L5.49324 16.8072C5.48489 16.7285 5.47655 16.6508 5.46873 16.5715C5.40927 16.0036 5.0072 15.4477 4.37357 15.4764C3.83121 15.5004 3.21479 15.9614 3.27841 16.5715L3.64607 20.1011L4.40642 27.4021C4.62302 29.4759 4.8391 31.5501 5.05465 33.6247C5.09637 34.022 5.13548 34.4205 5.17929 34.8179C5.41762 36.9894 7.07599 38.1596 9.12967 38.4892C10.3291 38.6822 11.5578 38.7218 12.775 38.7416C14.3353 38.7667 15.9113 38.8267 17.4461 38.544C19.7203 38.1268 21.4267 36.6082 21.6702 34.2526C21.7398 33.5725 21.8093 32.8923 21.8788 32.2119C22.11 29.9618 22.3409 27.7115 22.5714 25.4611L23.3255 18.1079L23.6713 14.7379C23.6885 14.5708 23.759 14.4137 23.8725 14.2898C23.986 14.1659 24.1363 14.0819 24.3012 14.0501C24.9515 13.9233 25.5732 13.7069 26.0357 13.212C26.7721 12.424 26.9187 11.3967 26.6584 10.3609ZM2.19525 11.0879C2.20516 11.0832 2.18691 11.1682 2.17909 11.2079C2.17752 11.1479 2.18065 11.0947 2.19525 11.0879ZM2.25836 11.5761C2.26357 11.5724 2.27921 11.5933 2.29538 11.6183C2.27087 11.5953 2.25523 11.5781 2.25783 11.5761H2.25836ZM2.32041 11.6579C2.34284 11.696 2.35483 11.72 2.32041 11.6579V11.6579ZM2.44505 11.7591H2.44818C2.44818 11.7627 2.45392 11.7664 2.456 11.7701C2.45255 11.766 2.4487 11.7624 2.44453 11.7591H2.44505ZM24.271 11.6079C24.0373 11.83 23.6853 11.9333 23.3375 11.9849C19.4366 12.5638 15.479 12.8569 11.5354 12.7275C8.71299 12.6311 5.92035 12.3176 3.12613 11.9229C2.85234 11.8843 2.55561 11.8342 2.36735 11.6324C2.01273 11.2517 2.18691 10.4851 2.27921 10.0251C2.3637 9.60373 2.52536 9.04207 3.02653 8.9821C3.80878 8.89031 4.71724 9.22042 5.49115 9.33776C6.4229 9.47996 7.35813 9.59382 8.29683 9.67935C12.303 10.0444 16.3765 9.98755 20.3649 9.45354C21.0919 9.35584 21.8163 9.24233 22.538 9.11299C23.181 8.99774 23.8939 8.78132 24.2825 9.44728C24.5489 9.90098 24.5844 10.508 24.5432 11.0207C24.5305 11.244 24.4329 11.4541 24.2705 11.6079H24.271Z"
                    fill="#FFFFFF" />
            </svg>
        </a>
    </div>

    <!-- GITHUB STAR LOGIC -->
    <script>
        fetch('https://api.github.com/repos/Manav-repo/Timer-pro')
            .then(r => r.json())
            .then(d => {
                const el = document.getElementById('starCount');
                if (d.stargazers_count !== undefined) {
                    el.innerText = d.stargazers_count + " Stars";
                } else {
                    el.innerText = "Star Me";
                }
            })
            .catch(() => document.getElementById('starCount').innerText = "Star");
    </script>

    <script>
        const CONFIG = { baseStrokeDesktop: 50, baseStrokeMobile: 20 };
        const formatTime = (seconds) => ({ m: Math.floor(seconds / 60).toString(), s: (seconds % 60).toString().padStart(2, '0') });
        const formatDur = (s) => s >= 60 ? `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')} min` : `${s} sec`;
        const isMobile = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 768;

        // --- MOMENTUM PICKER ---
        class MomentumPicker {
            constructor(element, options = {}) {
                this.element = element; this.min = options.min || 0; this.max = options.max || 99; this.step = options.step || 1;
                this.currentValue = options.initialValue || 0; this.itemHeight = 60; this.scrollPos = 0; this.items = [];
                for (let i = this.min; i <= this.max; i += this.step) this.items.push(i);
                this.render(); this.attachEvents(); this.snapToValue(this.currentValue);
            }
            render() {
                this.element.className = 'picker-wheel'; this.element.innerHTML = '';
                this.scrollCont = document.createElement('div'); this.scrollCont.style.cssText = 'position:relative;will-change:transform;';
                this.scrollCont.appendChild(this.createItem(''));
                this.items.forEach(v => this.scrollCont.appendChild(this.createItem(String(v).padStart(2, '0'))));
                this.scrollCont.appendChild(this.createItem(''));
                this.element.appendChild(this.scrollCont);
                const h = document.createElement('div'); h.className = 'picker-highlight'; this.element.appendChild(h);
            }
            createItem(txt) { const d = document.createElement('div'); d.className = 'picker-item'; d.innerText = txt; return d; }
            attachEvents() {
                let startY = 0, lastY = 0, vel = 0, raf;
                const move = (y) => { const dy = y - lastY; this.scrollPos += dy; this.update(); lastY = y; vel = dy; };
                const end = () => { if (Math.abs(vel) > 1) { let decel = 0.95; const coast = () => { this.scrollPos += vel; vel *= decel; this.update(); if (Math.abs(vel) > 0.5) raf = requestAnimationFrame(coast); else snap(); }; raf = requestAnimationFrame(coast); } else snap(); };
                const snap = () => { const idx = Math.round(-this.scrollPos / this.itemHeight); const safe = Math.max(0, Math.min(this.items.length - 1, idx)); this.scrollTo(safe); };
                this.element.addEventListener('touchstart', e => { startY = lastY = e.touches[0].clientY; vel = 0; if (raf) cancelAnimationFrame(raf); }, { passive: true });
                this.element.addEventListener('touchmove', e => { move(e.touches[0].clientY); }, { passive: true });
                this.element.addEventListener('touchend', end);
                this.element.addEventListener('mousedown', e => { startY = lastY = e.clientY; vel = 0; if (raf) cancelAnimationFrame(raf); const mm = ev => { move(ev.clientY) }; const mu = () => { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); end(); }; document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu); });
            }
            update() {
                const min = -(this.items.length - 1) * this.itemHeight; this.scrollPos = Math.max(min, Math.min(0, this.scrollPos));
                this.scrollCont.style.transform = `translateY(${this.scrollPos}px)`;
                const selIdx = Math.round(-this.scrollPos / this.itemHeight);
                this.scrollCont.querySelectorAll('.picker-item').forEach((el, i) => el.classList.toggle('selected', i === selIdx + 1));
                this.currentValue = this.items[Math.max(0, Math.min(this.items.length - 1, selIdx))];
            }
            scrollTo(idx) { this.scrollPos = -idx * this.itemHeight; this.scrollCont.style.transition = 'transform 0.3s cubic-bezier(0.2,0.8,0.2,1)'; this.update(); setTimeout(() => this.scrollCont.style.transition = '', 300); }
            snapToValue(v) { const i = this.items.indexOf(v); if (i !== -1) this.scrollTo(i); }
            getValue() { return this.currentValue; }
        }

        // --- AUDIO ENGINE ---
        const AudioEngine = {
            ctx: null,
            init() {
                if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playTone(freq, type, duration, vol = 0.5) {
                if (!this.ctx) this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.stop(this.ctx.currentTime + duration);
            },
            playCount(val) {
                // High blip for 3, 2, 1
                if (val <= 3 && val > 0) this.playTone(800, 'sine', 0.15, 0.3);
            },
            playGo() {
                // Higher long beep for GO
                this.playTone(1200, 'square', 0.4, 0.2);
            },
            playWhistle() {
                // Sports Whistle Effect (Modulating Sine)
                if (!this.ctx) this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(2500, now);
                osc.frequency.linearRampToValueAtTime(1500, now + 0.1);
                osc.frequency.linearRampToValueAtTime(2500, now + 0.2);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(now);
                gain.gain.setValueAtTime(0.4, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
                osc.stop(now + 0.6);
            },
            playBuzzer() {
                // 90s Arcade "Game Over" Buzz
                if (!this.ctx) this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = 'square'; // Classic 8-bit texture
                osc.frequency.setValueAtTime(100, now); // Start low
                osc.frequency.linearRampToValueAtTime(50, now + 0.8); // Slide down (Power down effect)

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                osc.start(now);
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
                osc.stop(now + 0.8);
            }
        };

        // --- TIMER ENGINE ---
        class TimerEngine {
            constructor(onTick, onComplete) {
                this.onTick = onTick; this.onComplete = onComplete;
                this.running = false; this.remaining = 0; this.duration = 0; this.endTime = 0;
            }
            start(s) { if (s <= 0) return; this.duration = s; this.remaining = s; this.endTime = performance.now() + s * 1000; this.running = true; this.loop(); toggleFocusMode(true); }
            resume() { if (!this.running && this.remaining > 0) { this.running = true; this.endTime = performance.now() + this.remaining * 1000; this.loop(); toggleFocusMode(true); } }
            pause() { this.running = false; cancelAnimationFrame(this.raf); toggleFocusMode(false); }
            reset() { this.running = false; cancelAnimationFrame(this.raf); this.remaining = 0; toggleFocusMode(false); }
            loop() {
                if (!this.running) return;
                const left = Math.ceil((this.endTime - performance.now()) / 1000);
                if (left !== this.remaining) {
                    this.remaining = left;
                    AudioEngine.playCount(left); // Countdown Sound
                    this.onTick(this.remaining, this.duration);
                }
                if (left <= 0) {
                    this.running = false;
                    this.onTick(0, this.duration);
                    this.onComplete();
                    toggleFocusMode(false);
                }
                else this.raf = requestAnimationFrame(this.loop.bind(this));
            }
        }

        // --- CIRCUIT CONTROLLER (UNIFIED DND) ---
        const CircuitController = {
            queue: [], queueIndex: 0,

            init() {
                if (STATE.workout.length === 0) {
                    STATE.circuitRounds = 3;
                    STATE.workout = [
                        { name: "Push ups", duration: 30 },
                        { name: "Abs Plank", duration: 70 },
                        { name: "Squats", duration: 45 },
                        { name: "Rest Period", duration: 30 }
                    ];
                }
                this.renderEditor();
            },

            renderEditor() {
                const con = document.getElementById('interval-list');
                const roundsEl = document.getElementById('rounds-count');
                const totalEl = document.getElementById('total-duration');

                roundsEl.innerText = STATE.circuitRounds;
                con.innerHTML = '';

                let totalSec = 0;

                // Drop Indicator Element (Stored in Controller for reuse)
                if (!this.dropLineEl) {
                    this.dropLineEl = document.createElement('div');
                    this.dropLineEl.className = 'drop-indicator';
                }

                STATE.workout.forEach((item, i) => {
                    totalSec += item.duration;
                    const card = document.createElement('div');
                    card.className = 'interval-card';
                    card.dataset.index = i;

                    // Unified Mouse/Touch Listener on Handle
                    const handle = document.createElement('div');
                    handle.className = 'drag-handle';
                    handle.innerText = '::';
                    handle.onmousedown = (e) => this.dragStart(e, i, card, false);
                    handle.ontouchstart = (e) => this.dragStart(e, i, card, true);

                    card.appendChild(handle);

                    // Body
                    const inputs = document.createElement('input');
                    inputs.className = 'card-name-input';
                    inputs.value = item.name;
                    inputs.onchange = (e) => this.updateIt(i, 'name', e.target.value);
                    card.appendChild(inputs);

                    const ctrls = document.createElement('div');
                    ctrls.className = 'time-control-group';
                    ctrls.innerHTML = `
                        <button class="mini-btn" onclick="CircuitController.adjustTime(${i}, -5)">-</button>
                        <div class="time-display-box" onclick="CircuitController.adjustTime(${i}, 5)">${formatDur(item.duration)}</div>
                        <button class="mini-btn" onclick="CircuitController.adjustTime(${i}, 5)">+</button>
                    `;
                    card.appendChild(ctrls);

                    const del = document.createElement('button');
                    del.className = 'btn-delete';
                    del.innerHTML = `<svg width="14" height="18" viewBox="0 0 14 18" fill="none"><path d="M1 16C1 17.1 1.9 18 3 18H11C12.1 18 13 17.1 13 16V4H1V16ZM14 1H10.5L9.5 0H4.5L3.5 1H0V3H14V1Z" fill="#FF453A"/></svg>`;
                    del.onclick = () => this.deleteIt(i);
                    card.appendChild(del);

                    con.appendChild(card);
                });

                const grandTotal = totalSec * STATE.circuitRounds;
                const m = Math.floor(grandTotal / 60);
                const s = grandTotal % 60;
                totalEl.innerText = `Total Duration: ${m}m ${s}s`;
            },

            // --- UNIFIED DND LOGIC ---
            dragStart(e, index, card, isTouch) {
                e.preventDefault(); // Stop standard behavior
                this.dragIdx = index;
                this.dragOriginCard = card;

                // 1. Create Floating Ghost
                this.ghost = card.cloneNode(true);
                this.ghost.className = 'drag-ghost';
                this.ghost.style.setProperty('--ghost-width', card.offsetWidth + 'px');
                this.ghost.style.setProperty('--ghost-height', card.offsetHeight + 'px');

                const rect = card.getBoundingClientRect();
                const clientX = isTouch ? e.touches[0].clientX : e.clientX;
                const clientY = isTouch ? e.touches[0].clientY : e.clientY;

                // Offset calculation to keep mouse where it grabbed
                this.offsetX = clientX - rect.left;
                this.offsetY = clientY - rect.top;

                this.updateGhostPos(clientX, clientY);
                document.body.appendChild(this.ghost);

                // 2. Styling States
                document.getElementById('interval-list').classList.add('is-dragging-active');
                card.classList.add('drag-placeholder');
                if (navigator.vibrate) navigator.vibrate(50);

                // 3. Attach Global Listeners
                const moveFn = (ev) => this.onMove(ev, isTouch);
                const endFn = (ev) => {
                    document.removeEventListener(isTouch ? 'touchmove' : 'mousemove', moveFn);
                    document.removeEventListener(isTouch ? 'touchend' : 'mouseup', endFn);
                    this.onEnd(ev);
                };

                document.addEventListener(isTouch ? 'touchmove' : 'mousemove', moveFn, { passive: false });
                document.addEventListener(isTouch ? 'touchend' : 'mouseup', endFn);
            },

            updateGhostPos(x, y) {
                this.ghost.style.top = (y - this.offsetY) + 'px';
                this.ghost.style.left = (x - this.offsetX) + 'px';
            },

            onMove(e, isTouch) {
                e.preventDefault();
                const x = isTouch ? e.touches[0].clientX : e.clientX;
                const y = isTouch ? e.touches[0].clientY : e.clientY;
                this.updateGhostPos(x, y);

                // Hit Test
                // Hide ghost momentarily to get element below? No, ghost has pointer-events: none
                const target = document.elementFromPoint(x, y);
                const card = target ? target.closest('.interval-card') : null;

                // Auto Scroll logic
                const list = document.getElementById('interval-list');
                if (y > window.innerHeight - 100) list.scrollBy(0, 5);
                if (y < 150) list.scrollBy(0, -5);

                const dropEl = this.dropLineEl;

                if (card && card !== this.dragOriginCard) {
                    const rect = card.getBoundingClientRect();
                    const mid = rect.top + rect.height / 2;
                    const isAfter = y > mid;

                    if (isAfter) {
                        if (card.nextSibling !== dropEl) card.parentNode.insertBefore(dropEl, card.nextSibling);
                        this.dropIndex = parseInt(card.dataset.index) + 1;
                    } else {
                        if (card.previousSibling !== dropEl) card.parentNode.insertBefore(dropEl, card);
                        this.dropIndex = parseInt(card.dataset.index);
                    }
                } else if (!card && dropEl.parentNode) {
                    // Keep it where it is or remove? Let's keep it if we are still near list
                }
            },

            onEnd(e) {
                this.ghost.remove();
                document.getElementById('interval-list').classList.remove('is-dragging-active');
                if (this.dragOriginCard) this.dragOriginCard.classList.remove('drag-placeholder');

                if (this.dropLineEl.parentNode) {
                    this.dropLineEl.remove(); // Remove indicator

                    if (this.dropIndex !== undefined && this.dropIndex !== null) {
                        let from = this.dragIdx;
                        let to = this.dropIndex;

                        // Adjustment because removing 'from' changes indices
                        if (from < to) to--;

                        // Array Logic
                        const [item] = STATE.workout.splice(from, 1);
                        STATE.workout.splice(to, 0, item);

                        this.renderEditor();
                        if (navigator.vibrate) navigator.vibrate(20);
                    }
                }

                this.dropIndex = null;
                this.dragOriginCard = null;
            },

            updateRounds(delta) {
                STATE.circuitRounds = Math.max(1, STATE.circuitRounds + delta);
                this.renderEditor();
                if (navigator.vibrate) navigator.vibrate(10);
            },

            adjustTime(i, delta) {
                STATE.workout[i].duration = Math.max(5, STATE.workout[i].duration + delta);
                this.renderEditor();
                if (navigator.vibrate) navigator.vibrate(10);
            },

            updateIt(i, k, v) { STATE.workout[i][k] = v; },
            deleteIt(i) { STATE.workout.splice(i, 1); this.renderEditor(); },
            addInterval() { STATE.workout.push({ name: "New Interval", duration: 30 }); this.renderEditor(); },

            compileQueue() {
                this.queue = [];
                // Add "Get Ready" Buffer
                this.queue.push({ name: "Get Ready", duration: 5, label: "Prepare" });

                for (let r = 1; r <= STATE.circuitRounds; r++) {
                    STATE.workout.forEach(item => {
                        this.queue.push({
                            name: item.name,
                            duration: item.duration,
                            label: `Round ${r}/${STATE.circuitRounds}`
                        });
                    });
                }
            },

            startQueue() {
                this.compileQueue();
                if (this.queue.length === 0) return;
                document.getElementById('editor-modal').classList.remove('open');
                this.queueIndex = -1;
                this.next();
            },

            next() {
                this.queueIndex++;
                if (this.queueIndex < this.queue.length) {
                    const item = this.queue[this.queueIndex];
                    document.getElementById('circuit-status').textContent = `${item.name} • ${item.label}`;

                    const name = item.name.toLowerCase();
                    const isRest = name.includes('rest') || name.includes('recover');
                    const isPrep = name.includes('get ready');

                    if (isPrep) document.body.className = 'theme-blue';
                    else if (isRest) document.body.className = 'theme-blue';
                    else document.body.className = 'theme-red';

                    if (!isPrep) AudioEngine.playWhistle(); // Start Whistle (skip on prepare)
                    else AudioEngine.playGo(); // Just a beep for prepare start

                    timer.start(item.duration);
                    VisualEngine.updateProgress(item.duration, item.duration);
                    QuickTimer.updateDisplay(item.duration);
                } else {
                    document.body.className = 'theme-red';
                    elTimerText.innerHTML = "Time's Up";
                    elTimerText.classList.add('long-text'); // Font Fix
                    AudioEngine.playBuzzer();
                    elBtnStart.textContent = "Start";
                }
            },

            start() {
                if (timer.running) { timer.pause(); elBtnStart.textContent = "Resume"; }
                else {
                    if (this.queue.length > 0 && this.queueIndex < this.queue.length) {
                        timer.resume();
                        elBtnStart.textContent = "Pause";
                    } else {
                        this.startQueue();
                    }
                }
            },

            reset() {
                timer.reset();
                this.queueIndex = 0;
                document.getElementById('circuit-status').textContent = "Ready";
                elBtnStart.textContent = "Start";
                QuickTimer.updateDisplay(0);
            }
        };

        const STATE = { mode: 'quick', defaultTime: 600, workout: [], circuitRounds: 3 };
        const elTimerText = document.getElementById('timer-text');
        const elBtnStart = document.getElementById('btn-start');
        const elBtnReset = document.getElementById('btn-reset');
        const elMobileInput = document.getElementById('mobileTimerInput');
        let minutesPicker, secondsPicker;

        const toggleFocusMode = (active) => {
            if (active) document.body.classList.add('running-focus');
            else document.body.classList.remove('running-focus');
        };

        const VisualEngine = {
            updateProgress(rem, tot) {
                const path = document.getElementById('border-path');
                path.style.strokeDashoffset = path.getTotalLength() * (1 - (tot - rem) / tot);
            }
        };

        const timer = new TimerEngine(
            (rem, tot) => {
                const t = formatTime(rem);
                document.querySelector('.minutes').textContent = t.m.padStart(2, '0');
                document.querySelector('.seconds').textContent = t.s;
                VisualEngine.updateProgress(rem, tot);
                if (STATE.mode === 'quick' && rem <= 10 && rem > 0 && !document.body.classList.contains('theme-red')) {
                    document.body.className = 'theme-red';
                }
            },
            () => {
                if (STATE.mode === 'circuit') CircuitController.next();
                else {
                    elTimerText.innerHTML = "Time's Up";
                    elTimerText.classList.add('long-text'); // Font Fix
                    document.body.className = 'theme-red';
                    AudioEngine.playBuzzer();
                    elBtnStart.textContent = "Start";
                }
            }
        );

        const QuickTimer = {
            init() {
                document.getElementById('circuit-status').classList.add('hidden');
                document.body.className = 'theme-black';
                this.updateDisplay(STATE.defaultTime);
                elBtnStart.textContent = "Start";
            },
            updateDisplay(s) {
                if (!document.querySelector('.minutes')) { elTimerText.innerHTML = `<span class="timer-segment minutes"></span><span class="timer-separator">:</span><span class="timer-segment seconds"></span>`; }
                const t = formatTime(s);
                elTimerText.classList.remove('long-text'); // Clear size fix
                document.querySelector('.minutes').textContent = t.m.padStart(2, '0');
                document.querySelector('.seconds').textContent = t.s;
            },
            start() {
                if (timer.running) { timer.pause(); elBtnStart.textContent = "Resume"; }
                else {
                    elMobileInput.classList.remove('open');
                    elTimerText.classList.remove('long-text'); // Clear size fix
                    // Check if showing "Time's Up" (previously DONE)
                    if (elTimerText.innerHTML === "Time's Up" || elTimerText.innerHTML === "DONE" || timer.remaining === 0) timer.start(STATE.defaultTime);
                    else timer.resume();
                    elBtnStart.textContent = "Pause";
                }
            },
            reset() {
                timer.reset(); document.body.className = 'theme-black'; this.updateDisplay(STATE.defaultTime); elBtnStart.textContent = "Start";
                VisualEngine.updateProgress(STATE.defaultTime, STATE.defaultTime);
            },
            updateTime(s) { STATE.defaultTime = s; this.reset(); }
        };

        window.setMode = mode => {
            STATE.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(mode)));
            if (mode === 'quick') {
                QuickTimer.init();
                document.getElementById('editor-modal').classList.remove('open');
            } else {
                CircuitController.init();
                document.getElementById('circuit-status').classList.remove('hidden');
                document.getElementById('editor-modal').classList.add('open');
            }
        };

        elBtnStart.onclick = () => STATE.mode === 'quick' ? QuickTimer.start() : CircuitController.start();
        elBtnReset.onclick = () => STATE.mode === 'quick' ? QuickTimer.reset() : CircuitController.reset();

        // Global Click to Toggle Controls (Mobile "Tap Anywhere")
        document.addEventListener('click', (e) => {
            if (!timer.running) return;
            // Ignore actual buttons/inputs
            if (e.target.closest('button') || e.target.closest('a') || e.target.closest('input')) return;

            toggleFocusMode(!document.body.classList.contains('running-focus'));
        });

        elTimerText.addEventListener('click', (e) => {
            if (e.target.closest('.timer-segment') || e.target.closest('#timer-text')) {
                if (STATE.mode === 'quick' && !timer.running) {
                    elMobileInput.classList.add('open');
                    if (!minutesPicker) {
                        minutesPicker = new MomentumPicker(document.getElementById('minutesPicker'), { max: 99, initialValue: 10 });
                        secondsPicker = new MomentumPicker(document.getElementById('secondsPicker'), { max: 59, step: 5 });
                    }
                }
            }
        });
        document.getElementById('setTimeBtn').onclick = () => {
            if (minutesPicker && secondsPicker) QuickTimer.updateTime(minutesPicker.getValue() * 60 + secondsPicker.getValue());
            elMobileInput.classList.remove('open');
        };

        class KeyboardShortcutsManager {
            constructor() { if (isMobile()) return; this.p = document.getElementById('shortcutsPanel'); this.init(); }
            init() {
                document.getElementById('shortcutsToggle').onclick = () => this.p.classList.toggle('visible');
                document.addEventListener('keydown', e => {
                    if (e.target.tagName === 'INPUT') return;
                    if (e.key === ' ') { e.preventDefault(); elBtnStart.click(); }
                    if (e.key.toLowerCase() === 'r') elBtnReset.click();
                    if (e.key === '?') this.p.classList.toggle('visible');
                });
            }
        }

        const updateLayout = () => {
            const w = window.innerWidth;
            const stroke = w < 768 ? CONFIG.baseStrokeMobile : CONFIG.baseStrokeDesktop;
            document.documentElement.style.setProperty('--progress-width', `${stroke}px`);
            const half = stroke / 2;
            const path = document.getElementById('border-path');
            const d = `M ${w / 2} ${half} L ${w - half} ${half} L ${w - half} ${window.innerHeight - half} L ${half} ${window.innerHeight - half} L ${half} ${half} L ${w / 2} ${half}`;
            path.setAttribute('d', d); path.style.strokeDasharray = path.getTotalLength();
        };

        window.addEventListener('resize', updateLayout);
        window.addEventListener('DOMContentLoaded', () => {
            updateLayout();
            if (!isMobile()) new KeyboardShortcutsManager();
            QuickTimer.init();
        });
    </script>
</body>

</html>